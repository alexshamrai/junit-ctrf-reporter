name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.4.0)'
        required: true
        type: string
      nextVersion:
        description: 'Next development version (e.g., 0.5.0-SNAPSHOT, leave empty to auto-increment)'
        required: false
        type: string

jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Validate and calculate versions
        id: versions
        run: |
          RELEASE_VERSION="${{ inputs.version }}"
          NEXT_VERSION="${{ inputs.nextVersion }}"
          
          echo "Preparing release version: $RELEASE_VERSION"
          echo "RELEASE_VERSION=$RELEASE_VERSION" >> $GITHUB_ENV
          echo "RELEASE_VERSION=$RELEASE_VERSION" >> $GITHUB_OUTPUT
          
          # Calculate next version if not provided
          if [ -z "$NEXT_VERSION" ]; then
            # Auto-increment minor version and add -SNAPSHOT
            MAJOR=$(echo $RELEASE_VERSION | cut -d. -f1)
            MINOR=$(echo $RELEASE_VERSION | cut -d. -f2)
            PATCH=$(echo $RELEASE_VERSION | cut -d. -f3)
            NEXT_MINOR=$((MINOR + 1))
            NEXT_VERSION="${MAJOR}.${NEXT_MINOR}.0-SNAPSHOT"
          fi
          
          echo "Next development version: $NEXT_VERSION"
          echo "NEXT_VERSION=$NEXT_VERSION" >> $GITHUB_ENV
          echo "NEXT_VERSION=$NEXT_VERSION" >> $GITHUB_OUTPUT

      - name: Create release branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          BRANCH_NAME="release/${{ env.RELEASE_VERSION }}"
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Update version in build.gradle
        run: |
          # Update releaseVersion to the version being released
          sed -i "s/releaseVersion = '.*'/releaseVersion = '${{ env.RELEASE_VERSION }}'/" build.gradle
          
          echo "Updated build.gradle:"
          cat build.gradle | grep -E "(releaseVersion|projectVersion)" || true

      - name: Update version in README.md
        run: |
          # Update Maven dependency version
          sed -i "s|junit-ctrf-reporter:[0-9.]*|junit-ctrf-reporter:${{ env.RELEASE_VERSION }}|g" README.md
          
          # Update Gradle dependency version
          sed -i "s|implementation 'io.github.alexshamrai:junit-ctrf-reporter:[0-9.]*'|implementation 'io.github.alexshamrai:junit-ctrf-reporter:${{ env.RELEASE_VERSION }}'|" README.md
          
          echo "Updated README.md:"
          cat README.md | grep "junit-ctrf-reporter:" || true

      - name: Commit and push changes
        run: |
          git add build.gradle README.md
          git commit -m "release: v${{ env.RELEASE_VERSION }}
          
          - Set releaseVersion to ${{ env.RELEASE_VERSION }}
          - Update README.md with version ${{ env.RELEASE_VERSION }}"
          
          echo "Pushing to origin/${{ env.BRANCH_NAME }}..."
          git push origin ${{ env.BRANCH_NAME }}
          
          echo "âœ… Changes committed and pushed successfully"
          
          # Wait for GitHub to process the push
          echo "Waiting for GitHub to synchronize..."
          sleep 10
          
          # Fetch to ensure we have the latest remote state
          git fetch origin
          
          # Verify the branch exists remotely
          echo "Verifying remote branch..."
          git ls-remote --heads origin ${{ env.BRANCH_NAME }}

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          gh pr create \
            --title "Release ${{ env.RELEASE_VERSION }}" \
            --body "## ðŸš€ Release Preparation for version ${{ env.RELEASE_VERSION }}
          
          This PR prepares the release branch for version ${{ env.RELEASE_VERSION }}.
          
          ## Changes
          
          - ðŸ“ Updated \`releaseVersion\` in \`build.gradle\` to \`${{ env.RELEASE_VERSION }}\`
          - ðŸ“ Updated dependency versions in \`README.md\` to \`${{ env.RELEASE_VERSION }}\`
          
          ## Next Steps
          
          **The package has been published to Maven Central from this release branch.**
          
          1. â³ Wait 15-30 minutes for Maven Central synchronization
          2. âœ… Verify the package at: https://search.maven.org/artifact/io.github.alexshamrai/junit-ctrf-reporter/${{ env.RELEASE_VERSION }}/jar
          3. ðŸ§ª Test the published package in a real project
          4. âœ… Once validated, merge this PR into \`master\`
          5. ðŸ·ï¸ Create a GitHub Release (optional)
          
          âš ï¸ **Do not merge until you have validated the package on Maven Central!**
          
          _This PR was automatically created by the release workflow._" \
            --base master \
            --head ${{ env.BRANCH_NAME }}

      - name: Publish summary
        run: |
          echo "## âœ… Release branch created successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release Version:** ${{ env.RELEASE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Next Version:** ${{ env.NEXT_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** release/${{ env.RELEASE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ The publish job will run next automatically" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "After publishing completes, validate the package before merging the PR." >> $GITHUB_STEP_SUMMARY