name: Publish to Maven Central

on:
  workflow_dispatch:
  push:
    branches:
      - 'release/**'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # Only run if it's a push to release branch OR a PR from release branch
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release/')) ||
      (github.event_name == 'pull_request' && startsWith(github.head_ref, 'release/')) ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Validate branch
        run: |
          # For push events
          if [[ "${{ github.event_name }}" == "push" ]]; then
            BRANCH_NAME="${{ github.ref_name }}"
          # For pull_request events
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BRANCH_NAME="${{ github.head_ref }}"
          # For workflow_dispatch
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi
          
          echo "Branch name: $BRANCH_NAME"
          
          if [[ ! "$BRANCH_NAME" =~ ^release/ ]]; then
            echo "âŒ This workflow can only be run from release/* branches"
            echo "Current branch: $BRANCH_NAME"
            exit 1
          fi
          echo "âœ… Running on release branch: $BRANCH_NAME"
          echo "RELEASE_BRANCH=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Extract version from build.gradle
        id: extract_version
        run: |
          RELEASE_VERSION=$(grep "releaseVersion = " build.gradle | sed "s/.*releaseVersion = '\(.*\)'/\1/")
          
          if [ -z "$RELEASE_VERSION" ]; then
            echo "âŒ Could not extract releaseVersion from build.gradle"
            exit 1
          fi
          
          echo "Publishing version: $RELEASE_VERSION"
          echo "RELEASE_VERSION=$RELEASE_VERSION" >> $GITHUB_ENV
          echo "RELEASE_VERSION=$RELEASE_VERSION" >> $GITHUB_OUTPUT

      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          gpg --list-secret-keys

      - name: Build and publish to Maven Central
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_PRIVATE_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          ./gradlew publishAllPublicationsToMavenCentralRepository --no-daemon --stacktrace

      - name: Publish release summary
        run: |
          echo "## âœ… Successfully published version ${{ env.RELEASE_VERSION }} to Maven Central" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Group: io.github.alexshamrai" >> $GITHUB_STEP_SUMMARY
          echo "- Artifact: junit-ctrf-reporter" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ env.RELEASE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Maven Central URL:**" >> $GITHUB_STEP_SUMMARY
          echo "https://repo1.maven.org/maven2/io/github/alexshamrai/junit-ctrf-reporter/${{ env.RELEASE_VERSION }}/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Maven Central Search:**" >> $GITHUB_STEP_SUMMARY
          echo "https://search.maven.org/artifact/io.github.alexshamrai/junit-ctrf-reporter/${{ env.RELEASE_VERSION }}/jar" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â±ï¸ **Note:** It may take 15-30 minutes for the artifact to appear on Maven Central" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§ª Next Steps - Validation Required:" >> $GITHUB_STEP_SUMMARY
          echo "1. â³ Wait 15-30 minutes for Maven Central synchronization" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… Verify the artifact appears in Maven Central Search (link above)" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸ§ª Test the published package in a real project" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… Once validated, merge the Pull Request to master" >> $GITHUB_STEP_SUMMARY
          echo "5. ðŸ·ï¸ Create a GitHub Release (optional)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Important:** Do not merge the PR until the package is validated!" >> $GITHUB_STEP_SUMMARY